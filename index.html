<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор земляники садовой v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.8.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <span class="decoration top-left"><i class="fas fa-leaf"></i></span>
        <span class="decoration top-right"><i class="fas fa-strawberry"></i></span>
        <span class="decoration bottom-left"><i class="fas fa-seedling"></i></span>
        <span class="decoration bottom-right"><i class="fas fa-tractor"></i></span>
        
        <h1><i class="strawberry-icon fas fa-strawberry"></i> Анализатор земляники</h1>
        <p class="description">Наведите камеру на куст земляники, чтобы определить количество спелых и неспелых ягод</p>
        
        <div id="webcam-container">
            <video id="webcam" autoplay playsinline></video>
        </div>
        
        <div id="controls">
            <button id="start"><i class="fas fa-camera"></i> Запустить камеру</button>
            <button id="camera-switch" style="display: none;"><i class="fas fa-sync-alt"></i> Сменить камеру</button>
            <button id="stop" style="display: none;"><i class="fas fa-stop"></i> Остановить</button>
        </div>
        
        <div class="loading">
            <div class="spinner"></div>
            <p>Загружаем модель...</p>
        </div>
        
        <div id="results">
            <div class="counters">
                <h3><i class="leaf-icon fas fa-apple-alt"></i> Количество ягод</h3>
                <div class="counter">
                    <div class="counter-color" style="background: var(--ripe);"></div>
                    <span id="ripe-count">0</span> спелых
                </div>
                <div class="counter">
                    <div class="counter-color" style="background: var(--unripe);"></div>
                    <span id="unripe-count">0</span> неспелых
                </div>
            </div>
            
            <div id="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>

    <script>
    // Добавьте в начало скрипта:
    const MODELS = {
        ripeness: {
            url: "https://teachablemachine.withgoogle.com/models/-gv8z_sYx/",
            classes: ["Спелые", "Неспелые"]
        },
        variety: {
            url: "https://teachablemachine.withgoogle.com/models/C15fQc8rl/", // Замените на реальный URL модели сортов
            classes: [], // Будет заполнено при загрузке
            details: {} // Будет заполнено при загрузке
        }
    };

    let currentMode = 'ripeness'; // Добавьте это для управления режимами

    // Добавьте элементы интерфейса для режима сортов (перед init()):
    const varietyNameEl = document.createElement('div');
    varietyNameEl.className = 'variety-name';
    varietyNameEl.textContent = '-';
    
    const varietyConfidenceEl = document.createElement('div');
    varietyConfidenceEl.className = 'variety-confidence';
    varietyConfidenceEl.textContent = 'Точность: -%';
    
    const varietyInfoEl = document.createElement('div');
    varietyInfoEl.className = 'variety-info';
    varietyInfoEl.innerHTML = `
        <h3><i class="fas fa-seedling"></i> Определенный сорт:</h3>
        <div class="variety-details">
            <p><i class="fas fa-info-circle"></i> <strong>Описание:</strong> <span id="variety-desc">-</span></p>
            <p><i class="fas fa-calendar-alt"></i> <strong>Срок созревания:</strong> <span id="variety-period">-</span></p>
            <p><i class="fas fa-weight"></i> <strong>Вес ягод:</strong> <span id="variety-weight">-</span></p>
        </div>
    `;
    
    // Обновите функцию predict():
    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        
        if (currentMode === 'ripeness') {
            let ripeCount = 0;
            let unripeCount = 0;
            
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].className === "Спелые" && prediction[i].probability > 0.7) {
                    ripeCount++;
                } else if (prediction[i].className === "Неспелые" && prediction[i].probability > 0.7) {
                    unripeCount++;
                }
            }
            
            ripeCountEl.textContent = ripeCount;
            unripeCountEl.textContent = unripeCount;
            updateChart(ripeCount, unripeCount);
            
        } else if (currentMode === 'variety') {
            let topPrediction = { className: "", probability: 0 };
            
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > topPrediction.probability) {
                    topPrediction = prediction[i];
                }
            }
            
            if (topPrediction.probability > 0.5) {
                const variety = topPrediction.className;
                const confidence = Math.round(topPrediction.probability * 100);
                const details = MODELS.variety.details[variety] || {};
                
                varietyNameEl.textContent = variety;
                varietyConfidenceEl.textContent = `Точность: ${confidence}%`;
                document.getElementById('variety-desc').textContent = details.desc || "Описание отсутствует";
                document.getElementById('variety-period').textContent = details.period || "-";
                document.getElementById('variety-weight').textContent = details.weight || "-";
                
                if (details.img) {
                    if (!document.getElementById('variety-image')) {
                        const img = document.createElement('img');
                        img.id = 'variety-image';
                        img.style.maxWidth = '100%';
                        img.style.borderRadius = '8px';
                        img.style.margin = '10px 0';
                        varietyInfoEl.querySelector('.variety-details').prepend(img);
                    }
                    document.getElementById('variety-image').src = details.img;
                }
            }
        }
    }

    // Добавьте переключение режимов (перед init()):
    function addModeSwitcher() {
        const modeSelector = document.createElement('div');
        modeSelector.className = 'mode-selector';
        modeSelector.innerHTML = `
            <button id="ripeness-mode" class="active"><i class="fas fa-check-circle"></i> Определение спелости</button>
            <button id="variety-mode"><i class="fas fa-dna"></i> Определение сорта</button>
        `;
        document.querySelector('.app-container').insertBefore(modeSelector, document.querySelector('#webcam-container'));
        
        document.getElementById('ripeness-mode').addEventListener('click', () => switchMode('ripeness'));
        document.getElementById('variety-mode').addEventListener('click', () => switchMode('variety'));
    }

    function switchMode(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        
        // Обновите UI в зависимости от режима
        if (mode === 'ripeness') {
            document.getElementById('results').style.display = 'flex';
            document.querySelector('.variety-info')?.remove();
            document.querySelector('.description').textContent = 
                "Наведите камеру на куст земляники, чтобы определить количество спелых и неспелых ягод";
        } else {
            document.getElementById('results').style.display = 'none';
            document.querySelector('.app-container').appendChild(varietyInfoEl);
            varietyInfoEl.prepend(varietyNameEl);
            varietyInfoEl.prepend(varietyConfidenceEl);
            document.querySelector('.description').textContent = 
                "Наведите камеру на ягоду земляники, чтобы определить её сорт";
        }
        
        // Перезагрузите камеру при смене режима
        if (webcam) {
            stopCamera();
            init();
        }
    }

    // Вызовите добавление переключателя в начале:
    addModeSwitcher();
</script>
