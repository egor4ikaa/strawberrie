<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор земляники садовой v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.8.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <span class="decoration top-left"><i class="fas fa-leaf"></i></span>
        <span class="decoration top-right"><i class="fas fa-strawberry"></i></span>
        <span class="decoration bottom-left"><i class="fas fa-seedling"></i></span>
        <span class="decoration bottom-right"><i class="fas fa-tractor"></i></span>
        
        <h1><i class="strawberry-icon fas fa-strawberry"></i> Анализатор земляники</h1>
        <p class="description">Наведите камеру на куст земляники, чтобы определить количество спелых и неспелых ягод</p>
        
        <div id="webcam-container">
            <video id="webcam" autoplay playsinline></video>
        </div>
        
        <div id="controls">
            <button id="start"><i class="fas fa-camera"></i> Запустить камеру</button>
            <button id="camera-switch" style="display: none;"><i class="fas fa-sync-alt"></i> Сменить камеру</button>
            <button id="stop" style="display: none;"><i class="fas fa-stop"></i> Остановить</button>
        </div>
        
        <div class="loading">
            <div class="spinner"></div>
            <p>Загружаем модель...</p>
        </div>
        
        <div id="results">
            <div class="counters">
                <h3><i class="leaf-icon fas fa-apple-alt"></i> Количество ягод</h3>
                <div class="counter">
                    <div class="counter-color" style="background: var(--ripe);"></div>
                    <span id="ripe-count">0</span> спелых
                </div>
                <div class="counter">
                    <div class="counter-color" style="background: var(--unripe);"></div>
                    <span id="unripe-count">0</span> неспелых
                </div>
            </div>
            
            <div id="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/-gv8z_sYx/";
        let model, webcam, maxPredictions;
        let chart = null;
        let currentFacingMode = 'environment'; // 'environment' для задней, 'user' для передней
        
        // Элементы интерфейса
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const cameraSwitchBtn = document.getElementById('camera-switch');
        const loadingDiv = document.querySelector('.loading');
        const resultsDiv = document.getElementById('results');
        const ripeCountEl = document.getElementById('ripe-count');
        const unripeCountEl = document.getElementById('unripe-count');
        const chartCanvas = document.getElementById('chart');
        
        // Инициализация
        startBtn.addEventListener('click', init);
        stopBtn.addEventListener('click', stopCamera);
        cameraSwitchBtn.addEventListener('click', switchCamera);
        
        async function init() {
            try {
                startBtn.disabled = true;
                loadingDiv.classList.add('show');
                
                // 1. Запрос доступа к камере
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }, 
                    audio: false 
                });
                
                // 2. Загрузка модели
                model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                maxPredictions = model.getTotalClasses();
                
                // 3. Настройка камеры
                webcam = new tmImage.Webcam(400, 400, true);
                await webcam.setup(stream);
                await webcam.play();
                document.getElementById('webcam-container').appendChild(webcam.canvas);
                
                // 4. Инициализация диаграммы
                initChart();
                
                // Показываем интерфейс
                loadingDiv.classList.remove('show');
                resultsDiv.classList.add('show');
                startBtn.style.display = 'none';
                cameraSwitchBtn.style.display = 'block';
                stopBtn.style.display = 'block';
                
                // Запускаем обработку
                window.requestAnimationFrame(loop);
                // проверка сорта
                if (currentMode === 'variety') {
                MODELS.variety.details = await loadVarietyData();
                // Обновляем список классов на основе загруженных данных
                MODELS.variety.classes = Object.keys(MODELS.variety.details);
        }
                
            } catch (error) {
                console.error("Ошибка:", error);
                alert(`Ошибка: ${error.message}`);
                loadingDiv.classList.remove('show');
                startBtn.disabled = false;
            }
        }
        
        async function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            stopCamera();
            await init();
        }
        
        function stopCamera() {
            if (webcam) {
                webcam.stop();
                const canvas = document.querySelector('#webcam-container canvas');
                if (canvas) {
                    document.getElementById('webcam-container').removeChild(canvas);
                }
            }
            stopBtn.style.display = 'none';
            cameraSwitchBtn.style.display = 'none';
            startBtn.style.display = 'block';
            startBtn.disabled = false;
            resultsDiv.classList.remove('show');
        }
        
        async function loop() {
            if (webcam) {
                webcam.update();
                await predict();
                window.requestAnimationFrame(loop);
            }
        }
        
        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let ripeCount = 0;
            let unripeCount = 0;
            
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].className === "Спелые" && prediction[i].probability > 0.7) {
                    ripeCount++;
                } else if (prediction[i].className === "Неспелые" && prediction[i].probability > 0.7) {
                    unripeCount++;
                }
            }
            
            // Обновляем счетчики
            ripeCountEl.textContent = ripeCount;
            unripeCountEl.textContent = unripeCount;
            
            // Обновляем диаграмму
            updateChart(ripeCount, unripeCount);


            if (topPrediction.probability > 0.5) {
            const variety = topPrediction.className;
            const confidence = Math.round(topPrediction.probability * 100);
            const details = MODELS.variety.details[variety] || {};
            
            varietyNameEl.textContent = variety;
            varietyConfidenceEl.textContent = `Точность: ${confidence}%`;
            varietyDescEl.textContent = details.desc || "Описание отсутствует";
            varietyPeriodEl.textContent = details.period || "-";
            varietyWeightEl.textContent = details.weight || "-";
            
            // Добавляем изображение сорта, если оно есть
            if (details.img) {
                if (!document.getElementById('variety-image')) {
                    const img = document.createElement('img');
                    img.id = 'variety-image';
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.style.margin = '10px 0';
                    varietyInfoEl.insertBefore(img, varietyDetailsEl);
                }
                document.getElementById('variety-image').src = details.img;
            }
        }
        }
        
        function initChart() {
            chart = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['Спелые: ', 'Неспелые: '],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(46, 204, 113, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Roboto',
                                    size: 14
                                },
                                padding: 20
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }
        
        function updateChart(ripe, unripe) {
            if (!chart) return;
            
            chart.data.datasets[0].data = [ripe, unripe];
            
            // Рассчитываем проценты
            const total = ripe + unripe;
            if (total > 0) {
                const ripePercent = Math.round((ripe / total) * 100);
                const unripePercent = 100 - ripePercent;
                chart.data.labels = [
                    `Спелые ${ripePercent}%`,
                    `Неспелые ${unripePercent}%`
                ];
            }
            
            chart.update();
        }
        // Вместо статического объекта MODELS.variety.details будем загружать данные с сайта
            async function loadVarietyData() {
            try {
                const response = await fetch('https://api.allorigins.win/get?url=' + 
                    encodeURIComponent('https://stroy-podskazka.ru/klubnika/sorta/'));
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                const parser = new DOMParser();
                const htmlDoc = parser.parseFromString(data.contents, 'text/html');
                
                // Парсим данные со страницы
                const varieties = {};
                const items = htmlDoc.querySelectorAll('.article-item');
                
                items.forEach(item => {
                    const title = item.querySelector('h2 a')?.textContent.trim();
                    if (!title) return;
                    
                    const img = item.querySelector('img')?.src;
                    const desc = item.querySelector('.article-excerpt')?.textContent.trim();
                    
                    // Извлекаем дополнительные характеристики (пример)
                    let period = '-', weight = '-';
                    const text = item.textContent;
                    
                    if (text.includes('созревания')) {
                        period = text.match(/созревания[^\.]+/i)?.[0] || '-';
                    }
                    if (text.includes('вес')) {
                        weight = text.match(/вес[^\.]+/i)?.[0] || '-';
                    }
                    
                    varieties[title] = {
                        desc: desc || "Описание отсутствует",
                        period,
                        weight,
                        img
                    };
                });
                
                return varieties;
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                return {}; // Возвращаем пустой объект в случае ошибки
            }
            }
    </script>
</body>
</html>
